(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7cd6c065"],{"0462":function(t,e,n){"use strict";var s=n("634f"),r=n.n(s);r.a},"22fc":function(t,e,n){},"634f":function(t,e,n){},6447:function(t,e,n){"use strict";n.r(e);var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("d2-container",[[n("div",[n("h1",[t._v("任务查询")])]),n("el-row",{attrs:{gutter:10}},[n("el-col",{attrs:{span:12}},[n("ServerTaskTable",{on:{previewTask:t.handlerPreviewTask}})],1),n("el-col",{attrs:{span:12}},[n("AnsibleResult",{ref:"ansibleResult"})],1)],1)]],2)},r=[],a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[n("el-row",{staticStyle:{"margin-bottom":"5px","margin-left":"0px"},attrs:{gutter:24}},[n("el-select",{attrs:{clearable:"",placeholder:"类型"},model:{value:t.queryParam.taskType,callback:function(e){t.$set(t.queryParam,"taskType","string"===typeof e?e.trim():e)},expression:"queryParam.taskType"}},t._l(t.taskTypeOptions,(function(t){return n("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})})),1),n("el-button",{staticStyle:{"margin-left":"5px"},on:{click:t.fetchData}},[t._v("查询")])],1),n("el-table",{staticStyle:{width:"100%"},attrs:{data:t.tableData}},[n("el-table-column",{attrs:{prop:"user",label:"用户"},scopedSlots:t._u([{key:"default",fn:function(e){return[null!==e.row.user&&null!==e.row.user.displayName?n("span",[t._v(t._s(e.row.user.displayName))]):t._e()]}}])}),n("el-table-column",{attrs:{prop:"taskType",label:"类型"},scopedSlots:t._u([{key:"default",fn:function(e){return[n("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(t._f("getServerTaskText")(e.row.taskType)))])]}}])}),n("el-table-column",{attrs:{prop:"taskSize",label:"机器数量"},scopedSlots:t._u([{key:"default",fn:function(e){return[n("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(e.row.taskSize))])]}}])}),n("el-table-column",{attrs:{prop:"finalized",label:"完成"},scopedSlots:t._u([{key:"default",fn:function(e){return[n("el-tag",{attrs:{type:1===e.row.finalized?"success":"danger","disable-transitions":""}},[t._v(t._s(1===e.row.finalized?"完成":"进行")+" ")])]}}])}),n("el-table-column",{attrs:{prop:"ago",label:"时间"}}),n("el-table-column",{attrs:{fixed:"right",label:"操作",width:"80"},scopedSlots:t._u([{key:"default",fn:function(e){return[n("el-button",{attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(n){return t.handlerPreview(e.row)}}},[t._v("详情")])]}}])})],1),n("el-pagination",{attrs:{background:"","page-sizes":[10,15,20,25,30],layout:"sizes, prev, pager, next",total:t.pagination.total,"current-page":t.pagination.currentPage,"page-size":t.pagination.pageSize},on:{"current-change":t.paginationCurrentChange,"size-change":t.handleSizeChange}})],1)},i=[],o=(n("a4d3"),n("4de4"),n("e439"),n("dbb4"),n("b64b"),n("159b"),n("ade3")),c=n("5880");function l(t){switch(t){case 0:return"Cmd";case 1:return"Script";case 2:return"Playbook";default:return"未定义"}}var u=n("67ee");function d(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,s)}return n}function h(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?d(Object(n),!0).forEach((function(e){Object(o["a"])(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var p=[{value:0,label:"批量命令"},{value:1,label:"批量脚本"},{value:2,label:"Playbook"}],m={name:"ServerTaskTable",data:function(){return{tableData:[],loading:!1,pagination:{currentPage:1,pageSize:10,total:0},queryParam:{userId:"",taskType:""},taskTypeOptions:p,title:"历史任务查询"}},filters:{getServerTaskText:l},computed:h({},Object(c["mapState"])("d2admin/user",["info"])),mounted:function(){this.initPageSize(),this.fetchData()},components:{},methods:h({},Object(c["mapActions"])({setPageSize:"d2admin/user/set"}),{handleSizeChange:function(t){this.pagination.pageSize=t,this.info.pageSize=t,this.setPageSize(this.info),this.fetchData()},initPageSize:function(){"undefined"!==typeof this.info.pageSize&&(this.pagination.pageSize=this.info.pageSize)},paginationCurrentChange:function(t){this.pagination.currentPage=t,this.fetchData()},handlerPreview:function(t){this.$emit("previewTask",t.id)},fetchData:function(){var t=this;this.loading=!0;var e=Object.assign({},this.queryParam);e.page=this.pagination.currentPage,e.length=this.pagination.pageSize,Object(u["p"])(e).then((function(e){t.tableData=e.body.data,t.pagination.total=e.body.totalNum,t.loading=!1}))}})},f=m,g=(n("d9ac"),n("2877")),v=function(t){t.options.__source="src/components/opscloud/ansible/ServerTaskTable.vue"},b=v,k=Object(g["a"])(f,a,i,!1,null,"6d3d49e7",null);"function"===typeof b&&b(k);var y=k.exports,S=n("ebec"),x={data:function(){return{serverTask:"",taskId:""}},mounted:function(){},components:{ServerTaskTable:y,AnsibleResult:S["a"]},methods:{handlerPreviewTask:function(t){this.$refs.ansibleResult.initData(t)}}},_=x,O=function(t){t.options.__source="src/pages/task/history/index.vue"},T=O,w=Object(g["a"])(_,s,r,!1,null,null,null);"function"===typeof T&&T(w);e["default"]=w.exports},"67ee":function(t,e,n){"use strict";n.d(e,"h",(function(){return r})),n.d(e,"i",(function(){return a})),n.d(e,"j",(function(){return i})),n.d(e,"o",(function(){return o})),n.d(e,"e",(function(){return c})),n.d(e,"a",(function(){return l})),n.d(e,"b",(function(){return u})),n.d(e,"m",(function(){return d})),n.d(e,"c",(function(){return h})),n.d(e,"q",(function(){return p})),n.d(e,"f",(function(){return m})),n.d(e,"n",(function(){return f})),n.d(e,"d",(function(){return g})),n.d(e,"r",(function(){return v})),n.d(e,"g",(function(){return b})),n.d(e,"l",(function(){return k})),n.d(e,"k",(function(){return y})),n.d(e,"p",(function(){return S}));var s=n("9bd2");function r(t){return Object(s["a"])({url:"/server/task/command/executor",method:"post",data:t})}function a(t){return Object(s["a"])({url:"/server/task/playbook/executor",method:"post",data:t})}function i(t){return Object(s["a"])({url:"/server/task/script/executor",method:"post",data:t})}function o(t){return Object(s["a"])({url:"/server/task/query?taskId="+t,method:"get"})}function c(){return Object(s["a"])({url:"/server/task/ansible/hosts/create",method:"get"})}function l(t){return Object(s["a"])({url:"/server/task/abort?taskId="+t,method:"get"})}function u(t){return Object(s["a"])({url:"/server/task/member/abort?memberId="+t,method:"get"})}function d(t){return Object(s["a"])({url:"/server/task/playbook/page/query",method:"post",data:t})}function h(t){return Object(s["a"])({url:"/server/task/playbook/add",method:"post",data:t})}function p(t){return Object(s["a"])({url:"/server/task/playbook/update",method:"put",data:t})}function m(t){return Object(s["a"])({url:"/server/task/playbook/del?id="+t,method:"delete"})}function f(t){return Object(s["a"])({url:"/server/task/script/page/query",method:"post",data:t})}function g(t){return Object(s["a"])({url:"/server/task/script/add",method:"post",data:t})}function v(t){return Object(s["a"])({url:"/server/task/script/update",method:"put",data:t})}function b(t){return Object(s["a"])({url:"/server/task/script/del?id="+t,method:"delete"})}function k(){return Object(s["a"])({url:"/server/task/ansible/version",method:"get"})}function y(){return Object(s["a"])({url:"/server/task/ansible/hosts/preview",method:"get"})}function S(t){return Object(s["a"])({url:"/server/task/history/page/query",method:"post",data:t})}},"95ff":function(t,e,n){"use strict";var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("el-dialog",{attrs:{title:t.title,visible:t.formStatus.visible,width:"80%","before-close":t.handlerCloseDialog},on:{"update:visible":function(e){return t.$set(t.formStatus,"visible",e)}}},[t._l(t.xterms,(function(e){return n("div",{key:e},[[n("el-col",{attrs:{span:24}},[n("el-card",{staticStyle:{"margin-right":"10px","margin-bottom":"10px"},attrs:{shadow:"hover","body-style":"padding: 2px"}},[n("div",{staticClass:"clearfix",staticStyle:{height:"15px"},attrs:{slot:"header"},slot:"header"},[n("span",[n("el-tag",[t._v(" "+t._s(e))])],1),n("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"退出",placement:"top-start"}},[n("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text"},on:{click:function(n){return t.handlerLogout(e)}}},[t._v(" Logout ")])],1),n("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"复制会话",placement:"top-start"}},[n("el-button",{staticStyle:{float:"right",padding:"3px 0","margin-right":"20px"},attrs:{type:"text"},on:{click:function(e){return t.handlerDuplicateSession()}}},[t._v("Duplicate ")])],1)],1),n("div",{staticClass:"xterm",attrs:{id:e}})])],1)]],2)})),n("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{attrs:{size:"mini"},on:{click:t.handlerExit}},[t._v("关闭")])],1)],2)},r=[],a=(n("4de4"),n("d81d"),n("b0c0"),n("1276"),n("c276")),i=(n("abb2"),n("fcf3")),o=n("47d0"),c=n("e232"),l="ws/xterm",u="XTERM",d={data:function(){return{title:"Web-XTerminal",socketURI:a["a"].wsUrl(l),server:{},addonMap:[],xterms:[],xtermMap:{},timer:null,xtermSize:{rows:30},xtermTheme:{foreground:"#FFFFFF",background:"#606266",cursor:"help"}}},name:"XTerm",props:["formStatus"],mixins:[],mounted:function(){this.setXTermSetting()},beforeDestroy:function(){try{for(var t in this.socket.close(),this.xtermMap)this.xtermMap[t].dispose()}catch(e){}clearInterval(this.timer)},methods:{setXTermSetting:function(){var t=this;Object(c["a"])(u).then((function(e){if(e.success)try{t.xtermTheme.foreground=e.body["XTERM_FOREGROUND"],t.xtermTheme.background=e.body["XTERM_BACKGROUND"],t.xtermSize.rows=e.body["XTERM_ROWS"]||30}catch(n){}else t.$message.error(e.msg)}))},handlerExit:function(){this.handlerClose();try{for(var t in this.socket.close(),this.xtermMap)this.xtermMap[t].dispose()}catch(e){}this.formStatus.visible=!1},initData:function(t){this.server=t,this.handlerLogin()},setTimer:function(){var t=this;this.timer=setInterval((function(){t.handlerSSHHeartbeat()}),1e4)},handlerSSHHeartbeat:function(){var t={status:"HEARTBEAT"};try{this.socketOnSend(JSON.stringify(t))}catch(e){}},initTermInstance:function(t){var e=this,n=t.name,s=new i["Terminal"]({rendererType:"canvas",allowTransparency:!0,fontSize:11,rows:this.xtermSize.rows,theme:this.xtermTheme,termName:"xterm",visualBell:!1,popOnBell:!1,scrollback:1e3,screenKeys:!1,debug:!1,cancelEvents:!1,cursorStyle:"underline",cursorBlink:!0,convertEol:!0});e.addonMap[n]=new o["FitAddon"],s.loadAddon(e.addonMap[n]),s.open(document.getElementById(n)),e.addonMap[n].fit(),s.focus(),s.onData((function(t){var s={data:t,status:"COMMAND",instanceId:n};e.socketOnSend(JSON.stringify(s))})),this.xtermMap[n]=s},handlerResize:function(){for(var t in this.xtermMap){this.addonMap[t].fit();var e={status:"RESIZE",instanceId:t,xtermWidth:7*this.addonMap[t]._terminal.cols,xtermHeight:document.getElementById(t).clientHeight};this.socketOnSend(JSON.stringify(e)),this.xtermMap[t].scrollToBottom()}},handlerDuplicateSession:function(){var t=this,e=this.server.name+"#"+a["a"].uuid(),n={status:"DUPLICATE_SESSION_IP",duplicateInstanceId:this.server.name,token:a["a"].cookies.get("token"),instanceId:e,xtermWidth:7*this.addonMap[e.split("#")[0]]._terminal.cols,xtermHeight:document.getElementById(e.split("#")[0]).clientHeight};this.xterms.push(e);var s={name:e,ip:this.server.privateIp};this.$nextTick((function(){t.initTermInstance(s),t.socketOnSend(JSON.stringify(n))}))},handlerLogout:function(t){var e={status:"LOGOUT",instanceId:t};this.socketOnSend(JSON.stringify(e));var n=this.xtermMap[t];n.dispose(),delete this.xtermMap[t],this.xterms=this.xterms.filter((function(e){return e!==t})),this.$message.warning(t+"终端已关闭")},handlerClose:function(){var t={status:"CLOSE"};this.socketOnSend(JSON.stringify(t)),this.xterms=[],this.xtermMap={},clearInterval(this.timer)},handlerCloseDialog:function(t){var e=this;this.$confirm("确定退出Web终端,并关闭所有会话?").then((function(n){t(),e.handlerExit()})).catch((function(t){}))},handlerLogin:function(){this.xtermMap={},this.initSocket(),this.setTimer()},initSocket:function(){this.socket=new WebSocket(this.socketURI),this.socketOnClose(),this.socketOnOpen(),this.socketOnError(),this.socketOnMessage()},socketOnOpen:function(){var t=this;this.socket.onopen=function(){try{t.xterms=[],t.xterms.push(t.server.name),t.$nextTick((function(){t.initTermInstance(t.server);var e={token:a["a"].cookies.get("token"),instanceId:t.server.name,ip:t.server.privateIp,status:"INITIAL_IP",xtermWidth:0,xtermHeight:308};t.socketOnSend(JSON.stringify(e)),t.$nextTick((function(){t.handlerResize()}))}))}catch(e){t.$message.error("登录失败，未选择服务器或其它原因")}}},socketOnClose:function(){this.socket.onclose=function(){}},socketOnError:function(){this.socket.onerror=function(){}},socketOnSend:function(t){this.socket.send(t)},socketOnMessage:function(){var t=this;this.socket.onmessage=function(e){var n=JSON.parse(e.data),s=t;n.map((function(t){s.xtermMap[t.instanceId].write(t.output)}))}}}},h=d,p=(n("0462"),n("2877")),m=function(t){t.options.__source="src/components/opscloud/xterm/XTerm.vue"},f=m,g=Object(p["a"])(h,s,r,!1,null,null,null);"function"===typeof f&&f(g);e["a"]=g.exports},d9ac:function(t,e,n){"use strict";var s=n("22fc"),r=n.n(s);r.a},ebec:function(t,e,n){"use strict";var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[""!=t.serverTask&&null!=t.serverTask.memberMap?n("el-tabs",{attrs:{"tab-position":"top"},model:{value:t.activeName,callback:function(e){t.activeName=e},expression:"activeName"}},[null!=t.serverTask.memberMap.EXECUTE_QUEUE?n("el-tab-pane",{attrs:{name:"execute"}},[n("span",{attrs:{slot:"label"},slot:"label"},[n("i",{staticClass:"el-icon-loading"}),t._v(" 执行中")]),t._l(t.serverTask.memberMap.EXECUTE_QUEUE,(function(e){return n("el-card",{key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[n("el-row",[n("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp))]),n("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")]),n("el-button",{staticStyle:{float:"right"},attrs:{type:"text"},on:{click:function(n){return t.abortServerTaskMember(e.id)}}},[t._v("停止")])],1),null!=e.outputMsgLog?n("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.outputMsgLog}}):t._e()],1)}))],2):t._e(),null!=t.serverTask.memberMap.QUEUE?n("el-tab-pane",{attrs:{name:"queue"}},[n("span",{attrs:{slot:"label"},slot:"label"},[n("i",{staticClass:"el-icon-video-pause"}),t._v(" 队列")]),t._l(t.serverTask.memberMap.QUEUE,(function(e){return n("el-card",{key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[n("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp))]),n("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")])],1)}))],2):t._e(),n("el-tab-pane",{attrs:{name:"finalized"}},[n("span",{attrs:{slot:"label"},slot:"label"},[n("i",{staticClass:"el-icon-check"}),t._v(" 完成")]),1===t.serverTask.finalized?n("div",[n("el-checkbox",{attrs:{indeterminate:t.isIndeterminate},on:{change:t.handleCheckAllChange},model:{value:t.checkAll,callback:function(e){t.checkAll=e},expression:"checkAll"}},[n("el-tag",{attrs:{size:"mini"}},[t._v(t._s(t.serverTask.taskStatistics.total))]),t._v(" 显示所有 ")],1),n("div",{staticStyle:{margin:"15px 0"}}),n("el-checkbox-group",{on:{change:t.handleCheckedResultsChange},model:{value:t.checkedResults,callback:function(e){t.checkedResults=e},expression:"checkedResults"}},t._l(t.resultOptions,(function(e){return n("el-checkbox",{key:e.key,attrs:{label:e.key}},[n("el-tag",{attrs:{size:"mini",type:e.type}},[t._v(t._s(e.count))]),t._v(" "+t._s(e.key)+" ")],1)})),1)],1):t._e(),t._l(t.serverTask.memberMap.FINALIZED,(function(e){return n("el-card",{directives:[{name:"show",rawName:"v-show",value:!e.hide,expression:"!member.hide"}],key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[n("el-row",[e.success?n("el-tag",{attrs:{"disable-transitions":"",color:"#5C887A"}},[n("span",{style:{color:"white"}},[t._v("success")])]):t._e(),e.success?t._e():n("el-tag",{attrs:{"disable-transitions":"",color:"#F56C6C"}},[n("span",{style:{color:"white"}},[t._v(t._s(e.taskResult))])]),n("el-tag",{style:{marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp)+" ")]),n("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")]),n("el-button",{staticStyle:{float:"right","margin-right":"20px"},attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(n){return t.handlerXTerm(e)}}},[t._v("登录 ")])],1),null==e.result&&null!=e.outputMsgLog?n("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.outputMsgLog}}):t._e(),null!=e.result?n("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.result.stdout}}):t._e(),e.showErrorLog?n("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.errorMsgLog}}):t._e()],1)}))],2)],1):t._e(),n("XTerm",{ref:"xtermDialog",attrs:{formStatus:t.formXtermStatus}})],1)},r=[],a=n("95ff"),i=n("67ee"),o={data:function(){return{formXtermStatus:{visible:!1},serverTask:"",resultOptions:[],isIndeterminate:!0,checkAll:!0,checkedResults:[],timer:null,taskId:"",activeName:"",options:{stripe:!0},playbook:{},playbookOptions:[],labelWidth:"100px"}},name:"AnsibleResult",props:[],mixins:[],mounted:function(){},components:{XTerm:a["a"]},methods:{initData:function(t){this.timer=null,this.activeName="execute",this.taskId=t,this.queryTask(),this.setTimer()},handlerXTerm:function(t){this.formXtermStatus.visible=!0;var e={name:t.hostPattern,privateIp:t.manageIp};this.$refs.xtermDialog.initData(e)},handleCheckAllChange:function(t){this.checkedResults=t?["successful","failed","error"]:[],this.isIndeterminate=!1,this.setServerTaskMemberHide()},handleCheckedResultsChange:function(t){var e=t.length;this.checkAll=e===this.checkedResults.length,this.isIndeterminate=e>0&&e<this.checkedResults.length,this.setServerTaskMemberHide()},setServerTaskMemberHide:function(){for(var t=0;t<this.serverTask.memberMap.FINALIZED.length;t++){for(var e=this.serverTask.memberMap.FINALIZED[t],n=!0,s=0;s<this.checkedResults.length;s++)if(e.taskResult.toLowerCase()===this.checkedResults[s]){n=!1;break}e.hide=n}},setTimer:function(){var t=this;null==this.timer&&(this.timer=setInterval((function(){t.queryTask(),console.log("开始定时...每n秒执行一次")}),3e3))},handleDialogCancel:function(t){this.$message({message:"取消保存",type:"warning"}),t()},abortServerTask:function(t){var e=this;Object(i["a"])(t).then((function(t){t.success?e.$message({message:"任务停止中!",type:"success"}):e.$message.error(t.msg)}))},abortServerTaskMember:function(t){var e=this;Object(i["b"])(t).then((function(t){t.success?e.$message({message:"任务停止中!",type:"success"}):e.$message.error(t.msg)}))},queryTask:function(){var t=this;Object(i["o"])(this.taskId).then((function(e){if(t.serverTask=e.body,1===e.body.finalized){clearInterval(t.timer),t.resultOptions=[];var n={key:"successful",count:t.serverTask.taskStatistics.successfulCount,type:"success"};t.resultOptions.push(n);var s={key:"failed",count:t.serverTask.taskStatistics.failedCount,type:"warning"};t.resultOptions.push(s);var r={key:"error",count:t.serverTask.taskStatistics.errorCount,type:"danger"};t.resultOptions.push(r),t.checkedResults=["successful","failed","error"],t.activeName="finalized"}}))}}},c=o,l=n("2877"),u=function(t){t.options.__source="src/components/opscloud/ansible/AnsibleResult.vue"},d=u,h=Object(l["a"])(c,s,r,!1,null,"aacf9960",null);"function"===typeof d&&d(h);e["a"]=h.exports}}]);